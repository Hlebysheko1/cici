#!/bin/bash

# !/bin/bash ‚Äî –≤–∫–∞–∑—É—î, —â–æ —Å–∫—Ä–∏–ø—Ç –ø–æ—Ç—Ä—ñ–±–Ω–æ –≤–∏–∫–æ–Ω—É–≤–∞—Ç–∏ —á–µ—Ä–µ–∑ bash.
# –Ø–∫—â–æ –∑–∞–ø—É—Å–∫–∞—Ç–∏ —Ñ–∞–π–ª –Ω–∞–ø—Ä—è–º—É (./script.sh), Linux –∑–Ω–∞—î, —á–∏–º –π–æ–≥–æ –æ–±—Ä–æ–±–∏—Ç–∏.


# –¥–ª—è –∑–∞–ø—É—Å–∫—É –∑ —Ç–µ—Ä–º—ñ–Ω–∞–ª—É –≤–≤–æ–¥–∏—Ç–µ 2 –∫–æ–º–∞–Ω–¥–∏ –Ω–∏–∂—á–µ
# –ø–µ—Ä—à–∞ –¥–∞—î –ø—Ä–∞–≤–æ –Ω–∞ –≤–∏–∫–æ–Ω–∞–Ω–Ω, –∞ –¥—Ä—É–≥–∞ –∑–∞–ø—É—Å–∫–∞—î
# chmod +x reload_cert.sh
# ./reload_cert.sh

# –ó–∞–¥–∞—î–º–æ —à–ª—è—Ö –¥–æ –∫–∞—Ç–∞–ª–æ–≥—É, –¥–µ –±—É–¥—É—Ç—å –∑–±–µ—Ä—ñ–≥–∞—Ç–∏—Å—è —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∏ Let's Encrypt.
# –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –ø–æ—Ç–æ—á–Ω—É –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—é (pwd), —â–æ–± –Ω–µ –∑–∞–ª–µ–∂–∞—Ç–∏ –≤—ñ–¥ –∞–±—Å–æ–ª—é—Ç–Ω–æ–≥–æ —à–ª—è—Ö—É.
CERT_DIR="$(pwd)/letsencrypt"               

# –ö–∞—Ç–∞–ª–æ–≥ –¥–ª—è —Ç–∞–∫ –∑–≤–∞–Ω–∏—Ö challenge-—Ñ–∞–π–ª—ñ–≤ (–≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è Certbot –¥–ª—è –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –¥–æ–º–µ–Ω—É)
WEBROOT_DIR="$(pwd)/html"

# üîπ –Ü–º'—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –∑ nginx ‚Äî –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –¥–ª—è –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è nginx –ø—ñ—Å–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—ñ–≤.
NGINX_CONTAINER="my-nginx"  # –∑–∞–º—ñ–Ω–∏ –Ω–∞ —Å–≤–æ—î, —è–∫—â–æ —ñ–º‚Äô—è —ñ–Ω—à–µ

# üîπ –ó–∞–ø—É—Å–∫–∞—î–º–æ —Ç–∏–º—á–∞—Å–æ–≤–∏–π (–æ–¥–Ω–æ—Ä–∞–∑–æ–≤–∏–π) –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑ –æ–±—Ä–∞–∑–æ–º certbot/certbot
docker run --rm \
  -v "$CERT_DIR:/etc/letsencrypt" \
  -v "$WEBROOT_DIR:/var/www/html" \
  certbot/certbot renew --webroot -w /var/www/html --quiet
# –æ–Ω–æ–≤–ª—é—î –ª–∏—à–µ —Ç–æ–¥—ñ, –∫–æ–ª–∏ –∑–∞–ª–∏—à–∏–ª–æ—Å—å –º–µ–Ω—à–µ 30 –¥–Ω—ñ–≤ –¥—ñ—ó —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—É
# –î–æ–¥–∞–π --force-renewal —ñ —Ç–æ–¥—ñ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –±—É–¥–µ –ø—Ä–∏–º—É—Å–æ–≤–∏–º
# certbot/certbot renew --force-renewal --webroot -w /var/www/html --quiet
# –ê–ª–µ —Ç–∞–∫–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –º–∞—î –ª—ñ–º—ñ—Ç –≤ 5 —Å–ø—Ä–æ–± –Ω–∞ —Ç–∏–∂–¥–µ–Ω—å
# --rm = –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤–∏–¥–∞–ª–∏—Ç–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø—ñ—Å–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è
# –º–æ–Ω—Ç—É—î–º–æ –ª–æ–∫–∞–ª—å–Ω—É –ø–∞–ø–∫—É —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—ñ–≤
# –º–æ–Ω—Ç—É—î–º–æ challenge-–ø–∞–ø–∫—É 
# –∑–∞–ø—É—Å–∫–∞—î–º–æ –∫–æ–º–∞–Ω–¥—É "renew" –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –≤—Å—ñ—Ö –∞–∫—Ç–∏–≤–Ω–∏—Ö —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—ñ–≤
# –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —á–µ—Ä–µ–∑ –≤–µ–±-–¥–æ—Å—Ç—É–ø –¥–æ challenge-—Ñ–∞–π–ª—ñ–≤
# –±–µ–∑ –∑–∞–π–≤–æ–≥–æ –≤–∏–≤–æ–¥—É –≤ –∫–æ–Ω—Å–æ–ª—å

# –ü—ñ—Å–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—ñ–≤ –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ nginx —É—Å–µ—Ä–µ–¥–∏–Ω—ñ –≤–∫–∞–∑–∞–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
docker exec "$NGINX_CONTAINER" nginx -s reload
# exec = –≤–∏–∫–æ–Ω—É—î–º–æ –∫–æ–º–∞–Ω–¥—É –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –∑–∞–ø—É—â–µ–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
# nginx -s reload = –∫–æ–º–∞–Ω–¥–∞ nginx, —â–æ "–ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂—É—î –∫–æ–Ω—Ñ—ñ–≥", –Ω–µ –∑—É–ø–∏–Ω—è—é—á–∏ —Å–µ—Ä–≤–µ—Ä